<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Group Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
</head>

<body class="h-screen flex bg-gray-100">

    <!-- Sidebar -->
    <aside class="w-64 bg-white shadow-lg border-r flex flex-col">
        <div class="p-4 font-bold text-lg border-b flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M17 20h5v-2a4 4 0 00-5-4M9 20H4v-2a4 4 0 015-4m7-4v4m0 0v4m0-4h4m-4 0H7" />
            </svg>
            Groups
        </div>
        <div class="flex-1 overflow-y-auto">
            <ul>
                <% users.forEach((user)=> {%>

                    <li onclick="selectUser(this,'<%= user._id %>')"
                        class="p-3 hover:bg-gray-100 cursor-pointer border-b">
                        <%=user.username%>
                    </li>

                    <%});%>
                        <% group.forEach((grp)=> {%>
                            <li onclick="selectGroup(this,'<%= grp._id %>',2)"
                                class="p-3 hover:bg-gray-100 cursor-pointer border-b ">
                                <%=grp.name%>
                            </li>
                            <%});%>


            </ul>
        </div>
    </aside>


    <main class="flex-1 flex flex-col">
        <%if(selectedUser){%>
            <div id="RoomName" class="p-4 border-b bg-white shadow-sm font-semibold"
                other_user_id="<%=selectedUser._id%>" chatType="Private">
                <%= selectedUser.username %>
            </div>
            <%}else{%>
                <div id="RoomName" class="p-4 border-b bg-white shadow-sm font-semibold" other_user_id="" chatType="">
                    None
                </div>


                <%}%>


                    <section id="chatContainer"
                        class="flex-1 px-8 py-6 min-h-[75vh] overflow-y-auto box-border space-y-8 bg-gray-50">

                        <% messages.reverse().forEach(message=> {
                            const isSender = message.sender._id.equals(selectedUser?._id); // current user is sender
                            %>
                            <div class="flex mb-2 <%= isSender ? 'justify-start' : 'justify-end' %> p-2">
                                <div
                                    class="<%= isSender ? 'bg-orange-400 text-white':'bg-green-400 text-black' %> px-4 py-2 rounded-xl max-w-md">
                                    <p>
                                        <%= message.message%>
                                    </p>

                                </div>
                            </div>
                            <% }) %>
                    </section>


                    <div class="p-4 bg-white border-t flex gap-2">
                        <input id="messageInput" type="text" placeholder="Type a message..."
                            class="flex-1 px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-400" />
                        <button id="sendBtn"
                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-full flex items-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M5 13l4 4L19 7" />
                            </svg>
                        </button>
                    </div>
    </main>

    <script>
        const sendBtn = document.getElementById("sendBtn");
        const input = document.getElementById("messageInput");
        const messagesDiv = document.getElementById("chatContainer");
        const userId = "<%= userId %>";
        let otherId = document.getElementById("RoomName").getAttribute("other_user_id");
        const socket = io({
            auth: {
                token: userId
            }
        });
        socket.on("connect", () => console.log("Connected:", socket.id));


        socket.on("chatMessage", (msg) => {
            console.log(msg);
            console.log("message is here")
           const isSender = msg.sender._id !== userId;
           console.log(isSender)

            messagesDiv.innerHTML += `
            <div class="flex mb-2 ${isSender ? 'justify-start' : 'justify-end'} p-2">
                <div
                    class="${isSender ? 'bg-orange-400 text-white' : 'bg-green-400 text-black'} px-4 py-2 rounded-xl max-w-md">
                    <p>
                        ${msg.message}
                    </p>

                </div>
            </div>`;

            messagesDiv.scrollBottom = messagesDiv.scrollHeight;
        });

        sendBtn.addEventListener("click", () => {
            const text = input.value.trim();
            if (!text) return;
            let chatType = document.getElementById("RoomName").getAttribute('chatType');
            console.log({ text, chatType })
            // if (chatType === "Private") {
            socket.emit("chatMessage", {
                message: text,
                sender: userId,
                receiver: otherId
            });
            // } else if (chatType === "Group") {
            //     console.log(otherId)
            //     socket.emit("groupMessage", {

            //         message: text,
            //         sender: userId,
            //         groupId: otherId
            //     });
            // }

            input.value = "";

        });

        async function selectUser(element, id) {
            otherId = id;
            socket.emit('joinRoom', { userId, otherId });
            window.location.href = `/chat/${id}`;
        }



        function selectGroup(element, id) {

            otherId = id;
            groupId = id;
            document.getElementById("RoomName").innerText = element ? element.innerText : "None";
            document.getElementById("RoomName").setAttribute("other_user_id", id);
            document.getElementById("RoomName").setAttribute('chatType', "Group");
            messagesDiv.innerHTML = '';
            // console.log({ userId, otherId });
            socket.emit('joinGroup', { userId, groupId });
        }
    </script>


</body>

</html>